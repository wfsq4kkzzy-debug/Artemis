{% extends "base.html" %}

{% block title %}{{ projekt.nazev }}{% endblock %}

{% block extra_css %}
<style>
    .project-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 1.5rem;
    }
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .info-card h5 {
        color: white;
        margin-bottom: 1rem;
    }
    .stat-box {
        background: rgba(255,255,255,0.15);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
    }
    .stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    .message-board {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }
    .message-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    .message-item.user-0 { border-left-color: #007bff; }
    .message-item.user-1 { border-left-color: #28a745; }
    .message-item.user-2 { border-left-color: #ffc107; }
    .message-item.user-3 { border-left-color: #dc3545; }
    .message-item.user-4 { border-left-color: #6f42c1; }
    .message-item.user-5 { border-left-color: #fd7e14; }
    .message-item.user-6 { border-left-color: #20c997; }
    .message-item.user-7 { border-left-color: #e83e8c; }
    .message-item.warning {
        border-left-color: #ffc107;
    }
    .message-item.info {
        border-left-color: #17a2b8;
    }
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .message-author {
        font-weight: 600;
        color: #333;
    }
    .message-time {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .message-content {
        color: #555;
        line-height: 1.6;
    }
    .menu-tile {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
        border: 2px solid transparent;
        text-decoration: none;
        color: inherit;
        display: block;
    }
    .menu-tile:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        text-decoration: none;
        color: inherit;
    }
    .menu-tile-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #007bff;
    }
    .menu-tile-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .menu-tile-desc {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .visual-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .visual-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    .expense-chart {
        height: 100px;
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .expense-bar {
        flex: 1;
        background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);
        border-radius: 4px 4px 0 0;
        min-height: 20px;
        position: relative;
    }
    .expense-bar-label {
        position: absolute;
        bottom: -20px;
        left: 0;
        right: 0;
        font-size: 0.7rem;
        text-align: center;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Hlavi캜ka projektu -->
    <div class="row mb-4">
        <div class="col-12 col-md-8">
            <h1>{{ projekt.nazev }}</h1>
            <p class="text-muted">{{ projekt.popis or 'Bez popisu' }}</p>
            <div class="mb-2">
                {% if projekt.status == 'planovani' %}
                    <span class="badge bg-secondary">Pl치nov치n칤</span>
                {% elif projekt.status == 'rozpracovani' %}
                    <span class="badge bg-warning text-dark">Rozpracov치n칤</span>
                {% elif projekt.status == 'ukonceny' %}
                    <span class="badge bg-success">Ukon캜en칳</span>
                {% else %}
                    <span class="badge bg-danger">{{ projekt.status }}</span>
                {% endif %}
                {% if projekt.created_by_user %}
                    <span class="badge bg-info ms-2">
                        <i class="fas fa-user-plus"></i> Zalo쬴l: {{ projekt.created_by_user.jmeno_prijmeni }}
                    </span>
                {% elif projekt.created_by_personnel %}
                    <span class="badge bg-info ms-2">
                        <i class="fas fa-user-plus"></i> Zalo쬴l: {{ projekt.created_by_personnel.jmeno_plne }}
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                <a href="{{ url_for('projects.sdilet_projekt', projekt_id=projekt.id) }}" class="btn btn-outline-success">
                    <i class="fas fa-share-alt"></i> <span class="d-none d-sm-inline">Sd칤let</span>
                </a>
                <a href="{{ url_for('projects.upravit', projekt_id=projekt.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit"></i> <span class="d-none d-sm-inline">Upravit</span>
                </a>
                <form method="POST" action="{{ url_for('projects.smazat', projekt_id=projekt.id) }}" 
                      onsubmit="return confirm('丘멆잺 OPRAVDU CHCETE SMAZAT PROJEKT \'{{ projekt.nazev }}\'?\\n\\n游댮 Tato akce je NEVRATN츼 a sma쬰:\\n\\n游늶 V projektu:\\n- V코echny rozpo캜tov칠 polo쬶y projektu\\n- V코echny v칳daje projektu ({{ expenses|length }} v칳daj콢)\\n- V코echny term칤ny\\n- V코echny zpr치vy\\n\\n游눯 V hlavn칤m rozpo캜tu:\\n- V코echny v칳daje tohoto projektu v rozpo캜tu\\n\\nPokra캜ovat?');" 
                      style="display: inline;">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Smazat</span>
                    </button>
                </form>
                <a href="{{ url_for('projects.seznam') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Zp캩t</span>
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Lev치 strana - Dla쬯ice s menu -->
        <div class="col-12 col-lg-6">
            <!-- Grafick칠 zn치zorn캩n칤 v칳daj콢, term칤n콢 a vzkaz콢 -->
            <div class="row g-3 mb-3">
                <!-- V칳daje -->
                <div class="col-12 col-md-4">
                    <div class="visual-card text-center">
                        <div class="visual-icon text-danger">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <h4 class="mb-1">{{ expenses|length }}</h4>
                        <div class="text-muted small">V칳daj콢</div>
                        {% if expenses|length > 0 %}
                        <div class="mt-2">
                            <strong class="text-danger">{{ "{:,.0f}".format(projekt.celkove_vydaje) }} K캜</strong>
                        </div>
                        {% endif %}
                        <a href="{{ url_for('projects.vydaje', projekt_id=projekt.id) }}" class="btn btn-sm btn-outline-danger mt-2">
                            <i class="fas fa-eye"></i> Zobrazit
                        </a>
                    </div>
                </div>
                
                <!-- Term칤ny -->
                <div class="col-12 col-md-4">
                    <div class="visual-card text-center">
                        <div class="visual-icon text-warning">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h4 class="mb-1">{{ milestones|length }}</h4>
                        <div class="text-muted small">Term칤n콢</div>
                        {% if milestones %}
                        {% set splneno = milestones|selectattr('status', 'equalto', 'splneno')|list|length %}
                        {% set aktivni = milestones|rejectattr('status', 'equalto', 'splneno')|list|length %}
                        <div class="mt-2">
                            <span class="badge bg-success">{{ splneno }} spln캩no</span>
                            <span class="badge bg-warning text-dark">{{ aktivni }} aktivn칤ch</span>
                        </div>
                        {% endif %}
                        <a href="{{ url_for('projects.terminy', projekt_id=projekt.id) }}" class="btn btn-sm btn-outline-warning mt-2">
                            <i class="fas fa-eye"></i> Zobrazit
                        </a>
                    </div>
                </div>
                
                <!-- Vzkazy -->
                <div class="col-12 col-md-4">
                    <div class="visual-card text-center">
                        <div class="visual-icon text-info">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h4 class="mb-1">{{ messages|length if messages else 0 }}</h4>
                        <div class="text-muted small">Vzkaz콢</div>
                        <div class="mt-2">
                            <small class="text-muted">Na n치st캩nce</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu dla쬯ice -->
            <div class="row g-3">
                <div class="col-6 col-md-4">
                    <a href="{{ url_for('projects.rozpocet', projekt_id=projekt.id) }}" class="menu-tile">
                        <div class="menu-tile-icon"><i class="fas fa-calculator"></i></div>
                        <div class="menu-tile-title">Rozpo캜et</div>
                        <div class="menu-tile-desc">Spr치va rozpo캜tu</div>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <a href="{{ url_for('projects.vydaje', projekt_id=projekt.id) }}" class="menu-tile">
                        <div class="menu-tile-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="menu-tile-title">V칳daje</div>
                        <div class="menu-tile-desc">{{ expenses|length }} v칳daj콢</div>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <a href="{{ url_for('projects.terminy', projekt_id=projekt.id) }}" class="menu-tile">
                        <div class="menu-tile-icon"><i class="fas fa-calendar-check"></i></div>
                        <div class="menu-tile-title">Term칤ny</div>
                        <div class="menu-tile-desc">{{ milestones|length }} term칤n콢</div>
                    </a>
                </div>
            </div>

            <!-- Sd칤len칤 projektu -->
            {% if shares %}
            <div class="project-card">
                <div class="card-header project-card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-share-alt"></i> Sd칤leno s</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>U쬴vatel</th>
                                    <th>Opr치vn캩n칤</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for share in shares %}
                                <tr>
                                    <td>
                                        <strong>
                                            {% if share.shared_with_user %}
                                                {{ share.shared_with_user.get('jmeno_prijmeni', share.shared_with_user.get('username', 'Nezn치m칳 u쬴vatel')) }}
                                            {% else %}
                                                Nezn치m칳 u쬴vatel
                                            {% endif %}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if share.permission == 'write' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-edit"></i> 칔prava
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-eye"></i> Zobrazen칤
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('projects.sdilet_projekt', projekt_id=projekt.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-share-alt"></i> Spravovat sd칤len칤
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Prav치 strana - N치st캩nka (50% 코칤콏ky) -->
        <div class="col-12 col-lg-6">
            <div class="message-board">
                <h5 class="mb-3">
                    <i class="fas fa-comments"></i> N치st캩nka
                    <span class="badge bg-primary ms-2">{{ messages|length if messages else 0 }}</span>
                </h5>

                <!-- Formul치콏 pro p콏id치n칤 vzkazu -->
                <div class="mb-4 p-3 bg-white rounded" style="box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    {% if current_user %}
                        <div class="mb-2 small text-muted">
                            <i class="fas fa-user"></i> P칤코ete jako: <strong>{{ current_user.jmeno_prijmeni }}</strong>
                        </div>
                    {% endif %}
                    <form method="POST" action="{{ url_for('projects.pridat_vzkaz', projekt_id=projekt.id) }}">
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm" 
                                      id="vzkaz_obsah" 
                                      name="obsah" 
                                      rows="3" 
                                      placeholder="Napi코te vzkaz pro t칳m..."
                                      required></textarea>
                        </div>
                        <div class="mb-2">
                            <label for="to_user_id" class="form-label small">Komu (voliteln칠 - pr치zdn칠 = v코em)</label>
                            <select class="form-select form-select-sm" id="to_user_id" name="to_user_id">
                                <option value="">V코em u쬴vatel콢m</option>
                                {% if uzivatele_projektu %}
                                {% for uzivatel in uzivatele_projektu %}
                                {% if uzivatel.id != current_user_id %}
                                <option value="{{ uzivatel.id }}">
                                    {{ uzivatel.jmeno_prijmeni }} ({{ uzivatel.username }})
                                </option>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-paper-plane"></i> Odeslat vzkaz
                        </button>
                    </form>
                    <div class="mt-2 small text-muted">
                        <i class="fas fa-info-circle"></i> V코echny konverzace se ukl치daj칤 do datab치ze pro pozd캩j코칤 dohled치n칤.
                    </div>
                </div>

                <!-- Seznam vzkaz콢 -->
                {% if messages and messages|length > 0 %}
                    <div>
                        {% for msg in messages|reverse %}
                        {% set user_index = loop.index0 % 8 %}
                        <div class="message-item user-{{ user_index }} {% if msg.get('typ') == 'upozorneni' %}warning{% elif msg.get('typ') == 'aktualizace' %}info{% endif %}">
                            <div class="message-header">
                                <div>
                                    <span class="message-author">
                                        {% if msg.get('created_by_initials') %}
                                            <span class="badge bg-secondary me-1">{{ msg.created_by_initials }}</span>
                                        {% endif %}
                                        {{ msg.get('autor', 'Nezn치m칳 autor') }}
                                        {% if msg.get('to_user') %}
                                            <i class="fas fa-arrow-right text-muted ms-1"></i>
                                            <small class="text-muted">{{ msg.to_user.jmeno_prijmeni }}</small>
                                        {% else %}
                                            <span class="badge bg-info ms-1">V코em</span>
                                        {% endif %}
                                    </span>
                                    <div class="message-time">
                                        <i class="fas fa-clock"></i> {{ msg.get('datum', '')[:16] if msg.get('datum') else 'Nezn치m칠 datum' }}
                                    </div>
                                </div>
                                {% if msg.get('typ') == 'upozorneni' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                                {% elif msg.get('typ') == 'aktualizace' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                                {% endif %}
                            </div>
                            <div class="message-content">
                                {{ msg.get('obsah', '')|nl2br|safe }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i> Zat칤m nejsou 쮂멳n칠 vzkazy. Bu캞te prvn칤!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
