{% extends "base.html" %}

{% block title %}Polo쬶y rozpo캜tu{% endblock %}

{% block content %}
<div class="container-fluid container-md mt-4">
    <div class="row mb-4">
        <div class="col-12 col-md-8">
            <h1 class="h3 h-md-2">
                <i class="fas fa-list"></i> Polo쬶y rozpo캜tu
            </h1>
            <p class="text-muted">Rok {{ rok }}</p>
        </div>
        <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
            <a href="{{ url_for('budget.pridat_polozku') }}" class="btn btn-success w-100 w-md-auto">
                <i class="fas fa-plus"></i> P콏idat polo쬶u
            </a>
        </div>
    </div>

    <!-- Filtry -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-12 col-md-4">
                    <label for="typ" class="form-label">Typ</label>
                    <select name="typ" id="typ" class="form-select" onchange="this.form.submit()">
                        <option value="">-- V코echny --</option>
                        <option value="naklad" {% if typ_filter == 'naklad' %}selected{% endif %}>N치klady</option>
                        <option value="vynos" {% if typ_filter == 'vynos' %}selected{% endif %}>V칳nosy</option>
                    </select>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-end">
                    <a href="{{ url_for('budget.seznam_polozek') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-times"></i> Zru코it filtr
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Souhrn -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title h6">
                        <i class="fas fa-arrow-down"></i> N치klady
                    </h5>
                    <p class="card-text h4 h-md-3 mb-1">{{ "{:,.2f}".format(naklady_celkem) }} K캜</p>
                    <small>Pln캩n칤: {{ "{:,.2f}".format(naklady_plneni) }} K캜 ({{ "{:.1f}".format((naklady_plneni/naklady_celkem*100) if naklady_celkem > 0 else 0) }}%)</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title h6">
                        <i class="fas fa-arrow-up"></i> V칳nosy
                    </h5>
                    <p class="card-text h4 h-md-3 mb-1">{{ "{:,.2f}".format(vynosy_celkem) }} K캜</p>
                    <small>Pln캩n칤: {{ "{:,.2f}".format(vynosy_plneni) }} K캜 ({{ "{:.1f}".format((vynosy_plneni/vynosy_celkem*100) if vynosy_celkem > 0 else 0) }}%)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabulka polo쬰k -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Seznam polo쬰k
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>칔캜et</th>
                            <th>Pod칰캜et</th>
                            <th>Popis</th>
                            <th class="text-end">Celkov칳 rozpo캜et</th>
                            <th class="text-end">Aktu치ln칤 pln캩n칤</th>
                            <th class="text-end">Procenta vy캜erp치n칤</th>
                            <th class="text-center">Typ</th>
                            <th class="text-center">Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for polozka in polozky %}
                        <tr class="{% if polozka.typ == 'naklad' %}table-danger-light{% else %}table-success-light{% endif %}" style="{% if polozka.typ == 'naklad' %}background-color: rgba(220, 53, 69, 0.05);{% else %}background-color: rgba(25, 135, 84, 0.05);{% endif %}">
                            <td><strong>{{ polozka.ucet }}</strong></td>
                            <td>{{ polozka.poducet or '-' }}</td>
                            <td>{{ polozka.popis }}</td>
                            <td class="text-end">
                                <strong>{{ "{:,.2f}".format(polozka.castka_float) }} K캜</strong>
                            </td>
                            <td class="text-end">
                                <span class="{% if polozka.aktualni_plneni > polozka.castka_float %}text-danger{% else %}text-success{% endif %}">
                                    {{ "{:,.2f}".format(polozka.aktualni_plneni) }} K캜
                                </span>
                            </td>
                            <td class="text-end">
                                <div class="d-flex align-items-center justify-content-end">
                                    <div class="progress me-2" style="width: 80px; height: 20px;">
                                        {% set procento = polozka.procenta_vycerpani %}
                                        <div class="progress-bar 
                                            {% if procento <= 50 %}bg-success
                                            {% elif procento <= 80 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                            style="width: {{ min(100, procento) }}%">
                                        </div>
                                    </div>
                                    <span class="small">{{ "{:.1f}".format(procento) }}%</span>
                                </div>
                            </td>
                            <td class="text-center">
                                {% if polozka.typ == 'naklad' %}
                                    <span class="badge bg-danger">N치klad</span>
                                {% else %}
                                    <span class="badge bg-success">V칳nos</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('budget.upravit_polozku', polozka_id=polozka.id) }}" 
                                       class="btn btn-outline-primary" title="Upravit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('budget.mesicni_aktualizace', polozka_id=polozka.id) }}" 
                                       class="btn btn-outline-info" title="M캩s칤캜n칤 aktualizace">
                                        <i class="fas fa-calendar-alt"></i>
                                    </a>
                                    <form method="POST" action="{{ url_for('budget.smazat_polozku', polozka_id=polozka.id) }}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('丘멆잺 OPRAVDU CHCETE SMAZAT POLO콯KU \'{{ polozka.popis }}\'?\\n\\n游댮 Tato akce je NEVRATN츼 a sma쬰:\\n- V코echny v칳daje nav치zan칠 na tuto polo쬶u ({{ polozka.vydaje|length if polozka.vydaje else 0 }} v칳daj콢)\\n- V코echny v칳nosy nav치zan칠 na tuto polo쬶u ({{ polozka.vynosy|length if polozka.vynosy else 0 }} v칳nos콢)\\n- V코echny m캩s칤캜n칤 aktualizace\\n\\nPokra캜ovat?');">
                                        <button type="submit" class="btn btn-outline-danger" title="Smazat">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle"></i> 콯치dn칠 polo쬶y rozpo캜tu
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3">CELKEM</th>
                            <th class="text-end">{{ "{:,.2f}".format(naklady_celkem + vynosy_celkem) }} K캜</th>
                            <th class="text-end">{{ "{:,.2f}".format(naklady_plneni + vynosy_plneni) }} K캜</th>
                            <th class="text-end">
                                {% set celkem_rozpocet = naklady_celkem + vynosy_celkem %}
                                {% set celkem_plneni = naklady_plneni + vynosy_plneni %}
                                {% set celkem_procento = (celkem_plneni / celkem_rozpocet * 100) if celkem_rozpocet > 0 else 0 %}
                                {{ "{:.1f}".format(celkem_procento) }}%
                            </th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

