{% extends "base.html" %}

{% block title %}Dashboard - Přehled rozpočtu{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 h-md-2">
                <i class="fas fa-chart-line"></i> Dashboard - Přehled rozpočtu
            </h1>
            <p class="text-muted">Rok {{ rok }}</p>
        </div>
    </div>

    {% if hlavni_rozpocet %}
    <!-- Hlavní přehled rozpočtu -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-wallet"></i> {{ hlavni_rozpocet.nazev }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row text-center g-3">
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Celkový rozpočet</h6>
                            <h3 class="text-primary h6 h-md-5">{{ "{:,.2f}".format(hlavni_rozpocet.castka_celkem_float) }} Kč</h3>
                        </div>
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Výdaje</h6>
                            <h3 class="text-danger h6 h-md-5">{{ "{:,.2f}".format(hlavni_rozpocet.celkove_vydaje) }} Kč</h3>
                        </div>
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Výnosy</h6>
                            <h3 class="text-success h6 h-md-5">{{ "{:,.2f}".format(hlavni_rozpocet.celkove_vynosy) }} Kč</h3>
                        </div>
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Bilance</h6>
                            <h3 class="{% if hlavni_rozpocet.bilance < 0 %}text-danger{% else %}text-success{% endif %} h6 h-md-5">
                                {{ "{:,.2f}".format(hlavni_rozpocet.bilance) }} Kč
                            </h3>
                        </div>
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Zbývá</h6>
                            <h3 class="{% if hlavni_rozpocet.zbytek < 0 %}text-danger{% else %}text-success{% endif %} h6 h-md-5">
                                {{ "{:,.2f}".format(hlavni_rozpocet.zbytek) }} Kč
                            </h3>
                        </div>
                        <div class="col-6 col-md-2">
                            <h6 class="text-muted small">Čerpání</h6>
                            <h3 class="h6 h-md-5">{{ "%.1f"|format(hlavni_rozpocet.procento_vycerpano) }}%</h3>
                            <div class="progress mt-2" style="height: 20px;">
                                {% set procento = hlavni_rozpocet.procento_vycerpano %}
                                <div class="progress-bar 
                                    {% if procento <= 50 %}bg-success
                                    {% elif procento <= 80 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ min(100, procento) }}%">
                                    <strong class="small">{{ "%.1f"|format(procento) }}%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if overview %}
    <!-- Rozpis podle kategorií -->
    <div class="row g-3 mb-4">
        {% for kat_data in overview.kategorie %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header" style="background-color: {{ kat_data.kategorie.barva }}; color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-tag"></i> {{ kat_data.kategorie.nazev }}
                    </h5>
                </div>
                <div class="card-body">
                    <h4 class="text-danger">{{ "{:,.2f}".format(kat_data.vydaje) }} Kč</h4>
                    
                    {% if kat_data.podkategorie %}
                        <hr>
                        <h6>Podkategorie:</h6>
                        <ul class="list-unstyled">
                            {% for sub_data in kat_data.podkategorie %}
                            <li>
                                <strong>{{ sub_data.podkategorie.nazev }}</strong>: 
                                {{ "{:,.2f}".format(sub_data.vydaje) }} Kč
                            </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


    <!-- Mzdové náklady detail -->
    {% if overview.mzdove_vydaje %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Mzdové náklady - detail
                    </h5>
                </div>
                <div class="card-body">
                    {% for mzd_data in overview.mzdove_vydaje %}
                        <h6>{{ mzd_data.kategorie.nazev }}</h6>
                        <p><strong>Celkem:</strong> {{ "{:,.2f}".format(mzd_data.celkem) }} Kč</p>
                        {% if mzd_data.by_personnel %}
                            <ul>
                                {% for personnel_id, castka in mzd_data.by_personnel.items() %}
                                <li>Personální záznam ID {{ personnel_id }}: {{ "{:,.2f}".format(castka) }} Kč</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        <hr>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Měsíční přehled -->
    {% if mesicni %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Měsíční přehled - Rok {{ rok }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Měsíc</th>
                                    <th class="text-end">Výdaje</th>
                                    <th class="text-end">Výnosy (plán)</th>
                                    <th class="text-end">Výnosy (skuteč)</th>
                                    <th class="text-end">Bilance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in mesicni %}
                                <tr>
                                    <td><strong>
                                        {% set mesice = ['', 'Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'] %}
                                        {{ mesice[m.mesic] }}
                                    </strong></td>
                                    <td class="text-end">
                                        <strong class="text-danger">{{ "{:,.2f}".format(m.vydaje) }} Kč</strong>
                                    </td>
                                    <td class="text-end">
                                        <span class="text-info">{{ "{:,.2f}".format(m.vynosy_planovane) }} Kč</span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-success">{{ "{:,.2f}".format(m.vynosy_skutecne) }} Kč</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong class="{% if m.bilance < 0 %}text-danger{% else %}text-success{% endif %}">
                                            {{ "{:,.2f}".format(m.bilance) }} Kč
                                        </strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th>Celkem</th>
                                    <th class="text-end">
                                        {% set celkem_vydaje = mesicni|sum(attribute='vydaje') %}
                                        {{ "{:,.2f}".format(celkem_vydaje) }} Kč
                                    </th>
                                    <th class="text-end">
                                        {% set celkem_vynosy_plan = mesicni|sum(attribute='vynosy_planovane') %}
                                        {{ "{:,.2f}".format(celkem_vynosy_plan) }} Kč
                                    </th>
                                    <th class="text-end">
                                        {% set celkem_vynosy_skut = mesicni|sum(attribute='vynosy_skutecne') %}
                                        {{ "{:,.2f}".format(celkem_vynosy_skut) }} Kč
                                    </th>
                                    <th class="text-end">
                                        {% set celkem_bilance = mesicni|sum(attribute='bilance') %}
                                        {{ "{:,.2f}".format(celkem_bilance) }} Kč
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Poslední výdaje -->
    {% if posledni_vydaje %}
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> Poslední výdaje
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Popis</th>
                                    <th>Kategorie</th>
                                    <th class="text-end">Částka</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vydaj in posledni_vydaje %}
                                <tr>
                                    <td>{{ vydaj.datum.strftime('%d.%m.%Y') if vydaj.datum else '-' }}</td>
                                    <td>{{ vydaj.popis }}</td>
                                    <td>
                                        <span class="badge" style="background-color: {{ vydaj.category.barva if vydaj.category else '#007bff' }}">
                                            {{ vydaj.category.nazev if vydaj.category else 'N/A' }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-danger">{{ "{:,.2f}".format(vydaj.castka_float) }} Kč</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Fallback - starý systém -->
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> Hlavní rozpočet není nastaven</h5>
        <p>Modul rozpočtu je ve vývoji. Prozatím se používá starý systém.</p>
        <a href="{{ url_for('budget.index') }}" class="btn btn-primary">Přejít na modul rozpočtu</a>
    </div>
    {% endif %}
</div>
{% endblock %}




